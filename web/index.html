<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­°äº‹éŒ²AIåˆ†æ</title>
    <link rel="stylesheet" href="css/style.css">
    <script>
    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        
        // Cognitoã‹ã‚‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ™‚ï¼ˆèªè¨¼ã‚³ãƒ¼ãƒ‰ã‚ã‚Šï¼‰
        if (code) {
            // èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’ãƒˆãƒ¼ã‚¯ãƒ³ã«äº¤æ›
            fetch('https://ap-northeast-1izajchzjd.auth.ap-northeast-1.amazoncognito.com/oauth2/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    grant_type: 'authorization_code',
                    client_id: '7k7s2cko3vdf94lfghdac07dc0',
                    code: code,
                    redirect_uri: location.origin
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.id_token) {
                    localStorage.setItem('cognitoIdToken', data.id_token);
                    // URLã‹ã‚‰codeãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰
                    window.history.replaceState({}, document.title, location.pathname);
                    location.reload();
                }
            })
            .catch(() => {
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸
                const loginUrl = 'https://ap-northeast-1izajchzjd.auth.ap-northeast-1.amazoncognito.com/login?client_id=7k7s2cko3vdf94lfghdac07dc0&response_type=code&scope=openid&redirect_uri=' + encodeURIComponent(location.origin);
                location.href = loginUrl;
            });
            return;
        }
        
        // é€šå¸¸ã®èªè¨¼ãƒã‚§ãƒƒã‚¯
        const token = localStorage.getItem('cognitoIdToken');
        if (!token) {
            const loginUrl = 'https://ap-northeast-1izajchzjd.auth.ap-northeast-1.amazoncognito.com/login?client_id=7k7s2cko3vdf94lfghdac07dc0&response_type=code&scope=openid&redirect_uri=' + encodeURIComponent(location.origin);
            location.href = loginUrl;
            return;
        }
        
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            if (payload.exp <= Date.now() / 1000) {
                localStorage.removeItem('cognitoIdToken');
                location.reload();
            }
        } catch {
            localStorage.removeItem('cognitoIdToken');
            location.reload();
        }
    })();
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¤ è­°äº‹éŒ²AIåˆ†æ</h1>
            <button id="logout-btn" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </header>
        
        <main>
            <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <section class="upload-section">
                <h2>ğŸ“ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
                <div id="drop-area" class="upload-area">
                    <input type="file" id="file-input" accept=".mp3,.mp4" style="display: none;">
                    <div class="upload-content">
                        <div class="upload-icon">ğŸ“</div>
                        <p class="upload-text">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„</p>
                        <p class="upload-or">ã¾ãŸã¯</p>
                        <button id="file-select-btn" class="file-select-btn">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
                        <p class="file-info">MP3ã€MP4ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œã€æœ€å¤§100MB</p>
                    </div>
                    <div id="upload-status" class="upload-status"></div>
                </div>
            </section>
            
            <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <section class="progress-section" id="progress-section" style="display: none;">
                <h2>ğŸ“Š å‡¦ç†é€²æ—</h2>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-steps">
                        <div class="step" id="step-upload">
                            <div class="step-icon">ğŸ“</div>
                            <div class="step-label">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
                        </div>
                        <div class="step" id="step-transcribe">
                            <div class="step-icon">ğŸ¤</div>
                            <div class="step-label">æ–‡å­—èµ·ã“ã—</div>
                        </div>
                        <div class="step" id="step-summarize">
                            <div class="step-icon">ğŸ“</div>
                            <div class="step-label">è¦ç´„</div>
                        </div>
                        <div class="step" id="step-analyze">
                            <div class="step-icon">ğŸ˜Š</div>
                            <div class="step-label">æ„Ÿæƒ…åˆ†æ</div>
                        </div>
                        <div class="step" id="step-complete">
                            <div class="step-icon">âœ…</div>
                            <div class="step-label">å®Œäº†</div>
                        </div>
                    </div>
                    <p class="progress-text" id="progress-text">å‡¦ç†ä¸­...</p>
                </div>
            </section>
            
            <!-- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <section class="download-section">
                <div class="section-header">
                    <h2>ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h2>
                    <p>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã«è¡¨ç¤ºã•ã‚ŒãŸã‚¸ãƒ§ãƒ–IDã‚’å…¥åŠ›ã—ã¦ã€å‡¦ç†å®Œäº†å¾Œã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
                <div class="download-form">
                    <label for="job-id-input">ã‚¸ãƒ§ãƒ–ID:</label>
                    <input type="text" id="job-id-input" placeholder="job_xxxxxxxxx_xxxxxxxxx" class="job-id-input">
                    <div class="download-buttons">
                        <button id="download-transcript" class="download-btn">æ–‡å­—èµ·ã“ã—</button>
                        <button id="download-summary" class="download-btn">è¦ç´„</button>
                        <button id="download-sentiment" class="download-btn">æ„Ÿæƒ…åˆ†æ</button>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1000.0.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/s3-client.js"></script>
    <script src="js/dynamo-client.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/upload.js"></script>
    <script src="js/main.js"></script>
</body>
</html>